<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Регистрация аккаунта</title>
    <link rel="stylesheet" href="./registation.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
</head>
<body>
    <section class="section_one_block">
        <div class="one_block">
            <h1>Регистрация аккаунта</h1>
            <div class="reg_forma">
                <input id="login" class="input" type="text" placeholder="Логин" />
                <input id="password" class="input" type="password" placeholder="Пароль" />
                <input id="FIO" class="input" type="text" placeholder="ФИО" />
                <input id="telephone" value="+7" name="phone" class="input2" type="tel" placeholder="Телефон" />
                <input id="email" class="input" type="email" placeholder="Email" />
                <div id="error-message" style="color: red; margin-top: 10px;text-align: center;"></div>
                <script>
                    const input = document.getElementById('telephone');

input.addEventListener('input', () => {
  let value = input.value;
  let digits = '';
  for (let i = 0; i < value.length; i++) {
    if (value[i] >= '0' && value[i] <= '9') {
      digits += value[i];
    }
  }

  if (digits.length === 0 || digits[0] !== '7') {
    digits = '7' + digits;
  } else {
    digits = '7' + digits.slice(1);
  }

  if (digits.length > 12) {
    digits = digits.slice(0, 12);
  }
  input.value = '+' + digits;
});
const z = document.getElementById('email');

z.addEventListener('input', () => {
  const emailValue = z.value;
  console.log(z.checkValidity())
  if (z.checkValidity()) {
    z.style.borderColor = '';
  } else {
    z.style.borderColor = 'red';
  }
});
const loginInput = document.getElementById('login');
const passwordInput = document.getElementById('password');
const FIOInput = document.getElementById('FIO');
const errorMessageDiv = document.getElementById('error-message');

loginInput.addEventListener('input', () => {
  const login = loginInput.value;
  
  if (login.length < 6) {
    errorMessageDiv.textContent = 'Логин должен быть не менее 6 символов.';
    return;
  }

  for (let i = 0; i < login.length; i++) {
    const ch = login[i];
    if (
      !(
        (ch >= 'A' && ch <= 'Z') ||
        (ch >= 'a' && ch <= 'z') ||
        (ch >= '0' && ch <= '9')
      )
    ) {
      errorMessageDiv.textContent = 'Логин должен содержать только латинские буквы и цифры.';
      return;
    }
  }
  errorMessageDiv.textContent = '';
});

passwordInput.addEventListener('input', () => {
  if (passwordInput.value.length < 8) {
    errorMessageDiv.textContent = 'Пароль должен быть не менее 8 символов.';
  } else {
    errorMessageDiv.textContent = '';
  }
});

FIOInput.addEventListener('input', () => {
  const FIO = FIOInput.value;
  for (let i = 0; i < FIO.length; i++) {
    const ch = FIO[i];
    if (
      !(
        (ch >= 'А' && ch <= 'Я') ||
        (ch >= 'а' && ch <= 'я') ||
        ch === 'Ё' || ch === 'ё' ||
        ch === ' '
      )
    ) {
      errorMessageDiv.textContent = 'ФИО должно содержать только кириллические буквы и пробелы.';
      return;
    }
  }
  errorMessageDiv.textContent = '';
});
                </script>
            </div>
            
            <div class="silki">
                <button id="create_button" class="create">Регистрация</button>
                <a href="./avtoriz.html" class="create">Вход</a>
            </div>
            
        </div>
        
         

    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.5.0/sql-wasm.js"></script>
    <script>
    //localStorage.clear()
 let db;
let SQL;

async function initSqlJsAsync() {
    return new Promise((resolve, reject) => {
        initSqlJs({ locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.5.0/${filename}` }).then(s => {
            resolve(s);
        }).catch(reject);
    });
}
    async function loadData(SQL) {
    const dataString = localStorage.getItem("sqlitedb");
    let database;
    if (dataString) {
        const uint8Array = Uint8Array.from(JSON.parse(dataString));
        database = new SQL.Database(uint8Array);
        
    } else {
        database = new SQL.Database();
        database.exec(`
            CREATE TABLE Orders (
                orders_id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                course TEXT,
                data_course TEXT,
                change_pay TEXT,
                State TEXT,
                Comments TEXT
            );
        `);

        database.exec(`
            CREATE TABLE users (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                password TEXT,
                FIO TEXT,
                telephone TEXT,
                email TEXT,
                id_orders INTEGER,
                role TEXT default 'user',
                FOREIGN KEY (user_id) REFERENCES Orders(user_id)
            );
        `);
    }

    return database;
}

    function saveDatabase() {
        const data = db.export();
        localStorage.setItem('sqlitedb', JSON.stringify(Array.from(data)));
    }

    function ensureColumnExists(tableName, columnName) {
    const result = db.exec(`PRAGMA table_info(${tableName});`);
    const columns = result.length > 0 ? result[0].values.map(row => row[1]) : [];
    if (!columns.includes(columnName)) {
        try {
            db.exec(`ALTER TABLE ${tableName} ADD COLUMN ${columnName} TEXT;`);
            console.log(`Добавлена колонка ${columnName}`);
            saveDatabase()
        } catch (e) {
            console.error(`Ошибка при добавлении колонки ${columnName}:`, e);
        }
    }
}
function displayUsers() {
    const res = db.exec("SELECT * FROM users;");
    if (res.length === 0) {
        console.log("Таблица users пуста");
        return;
    }
    const columns = res[0].columns;
    const values = res[0].values;
    console.table(values.map(row => {
        const obj = {};
        columns.forEach((col, index) => {
            obj[col] = row[index];
        });
        return obj;
    }));
}

async function main() {
    SQL = await initSqlJsAsync();
    db = await loadData(SQL);
    displayUsers()

    const requiredColumns = ['username', 'password', 'FIO', 'telephone', 'email'];
    requiredColumns.forEach(col => ensureColumnExists('users', col));

    document.getElementById('create_button').addEventListener('click', () => {
        const login = document.getElementById('login').value.trim();
        const password = document.getElementById('password').value.trim();
        const FIO = document.getElementById('FIO').value.trim();
        const telephone = document.getElementById('telephone').value.trim();
        const email = document.getElementById('email').value.trim();

        if (login && password && FIO && telephone && email) {
            try {
                const stmt = db.prepare(`INSERT INTO users (username, password, FIO, telephone, email) VALUES (?, ?, ?, ?, ?)`);
                stmt.run([login, password, FIO, telephone, email]);
                stmt.free();
                const errorMessageDiv = document.getElementById('error-message');
                errorMessageDiv.style = "color: green;text-align:center;"
                errorMessageDiv.innerText = "Успешная регистрация"

                setTimeout(() => {
                  errorMessageDiv.style = "color: green;"
                  errorMessageDiv.innerText = ""
                  window.location.href = "./avtoriz.html"
                }, 3000);
                
                saveDatabase(); 
                displayUsers();
            } catch (e) {
                alert('Ошибка при сохранении: ' + e.message);
            }
        } else {
            alert('Пожалуйста, заполните все поля.');
        }

        document.getElementById('login').value = '';
        document.getElementById('password').value = '';
        document.getElementById('FIO').value = '';
        document.getElementById('telephone').value = '';
        document.getElementById('email').value = '';
    });
}

    main()
    </script>
</body>
</html>